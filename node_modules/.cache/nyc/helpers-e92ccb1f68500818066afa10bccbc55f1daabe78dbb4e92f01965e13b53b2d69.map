{"version":3,"file":"C:/Users/full/Desktop/RealWordApp/cypress-realworld-app/backend/helpers.ts","sources":["C:/Users/full/Desktop/RealWordApp/cypress-realworld-app/backend/helpers.ts"],"names":[],"mappings":"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","sourcesContent":["import dotenv from \"dotenv\";\r\nimport { set } from \"lodash\";\r\nimport { Request, Response, NextFunction } from \"express\";\r\nimport { validationResult } from \"express-validator\";\r\nimport jwt from \"express-jwt\";\r\nimport jwksRsa from \"jwks-rsa\";\r\n\r\n// @ts-ignore\r\nimport OktaJwtVerifier from \"@okta/jwt-verifier\";\r\n// @ts-ignore\r\nimport awsConfig from \"../src/aws-exports\";\r\n\r\ndotenv.config();\r\n\r\nconst auth0JwtConfig = {\r\n  secret: jwksRsa.expressJwtSecret({\r\n    cache: true,\r\n    rateLimit: true,\r\n    jwksRequestsPerMinute: 5,\r\n    jwksUri: `https://${process.env.VITE_AUTH0_DOMAIN}/.well-known/jwks.json`,\r\n  }),\r\n\r\n  // Validate the audience and the issuer.\r\n  audience: process.env.VITE_AUTH0_AUDIENCE,\r\n  issuer: `https://${process.env.VITE_AUTH0_DOMAIN}/`,\r\n  algorithms: [\"RS256\"],\r\n};\r\n\r\n// Okta Validate the JWT Signature\r\nconst oktaJwtVerifier = new OktaJwtVerifier({\r\n  issuer: `https://${process.env.VITE_OKTA_DOMAIN}/oauth2/default`,\r\n  clientId: process.env.VITE_OKTA_CLIENTID,\r\n  assertClaims: {\r\n    aud: \"api://default\",\r\n    cid: process.env.VITE_OKTA_CLIENTID,\r\n  },\r\n});\r\nconst googleJwtConfig = {\r\n  secret: jwksRsa.expressJwtSecret({\r\n    cache: true,\r\n    rateLimit: true,\r\n    jwksRequestsPerMinute: 5,\r\n    jwksUri: \"https://www.googleapis.com/oauth2/v3/certs\",\r\n  }),\r\n\r\n  // Validate the audience and the issuer.\r\n  audience: process.env.VITE_GOOGLE_CLIENTID,\r\n  issuer: \"accounts.google.com\",\r\n  algorithms: [\"RS256\"],\r\n};\r\n\r\n/* istanbul ignore next */\r\nexport const verifyOktaToken = (req: Request, res: Response, next: NextFunction) => {\r\n  const bearerHeader = req.headers[\"authorization\"];\r\n\r\n  if (bearerHeader) {\r\n    const bearer = bearerHeader.split(\" \");\r\n    const bearerToken = bearer[1];\r\n\r\n    oktaJwtVerifier\r\n      .verifyAccessToken(bearerToken, \"api://default\")\r\n      .then((jwt: any) => {\r\n        // the token is valid\r\n        req.user = {\r\n          // @ts-ignore\r\n          sub: jwt.sub,\r\n        };\r\n        return next();\r\n      })\r\n      .catch((err: any) => {\r\n        // a validation failed, inspect the error\r\n        console.log(\"error\", err);\r\n      });\r\n  } else {\r\n    res.status(401).send({\r\n      error: \"Unauthorized\",\r\n    });\r\n  }\r\n};\r\n\r\n// Amazon Cognito Validate the JWT Signature\r\n// https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-verifying-a-jwt.html#amazon-cognito-user-pools-using-tokens-step-2\r\nconst userPoolId = awsConfig.Auth.Cognito.userPoolId;\r\nconst region = userPoolId.split(\"_\")[0];\r\nconst awsCognitoJwtConfig = {\r\n  secret: jwksRsa.expressJwtSecret({\r\n    jwksUri: `https://cognito-idp.${region}.amazonaws.com/${userPoolId}/.well-known/jwks.json`,\r\n  }),\r\n\r\n  issuer: `https://cognito-idp.${region}.amazonaws.com/${userPoolId}`,\r\n  algorithms: [\"RS256\"],\r\n};\r\n\r\nexport const checkAuth0Jwt = jwt(auth0JwtConfig).unless({ path: [\"/testData/*\"] });\r\nexport const checkCognitoJwt = jwt(awsCognitoJwtConfig).unless({ path: [\"/testData/*\"] });\r\nexport const checkGoogleJwt = jwt(googleJwtConfig).unless({ path: [\"/testData/*\"] });\r\n\r\nexport const ensureAuthenticated = (req: Request, res: Response, next: NextFunction) => {\r\n  if (req.isAuthenticated()) {\r\n    // @ts-ignore\r\n    // Map sub to id on req.user\r\n    if (req.user?.sub) {\r\n      /* istanbul ignore next */\r\n      // @ts-ignore\r\n      set(req.user, \"id\", req.user.sub);\r\n    }\r\n    return next();\r\n  }\r\n  /* istanbul ignore next */\r\n  res.status(401).send({\r\n    error: \"Unauthorized\",\r\n  });\r\n};\r\n\r\nexport const validateMiddleware = (validations: any[]) => {\r\n  return async (req: Request, res: Response, next: NextFunction) => {\r\n    await Promise.all(validations.map((validation: any) => validation.run(req)));\r\n\r\n    const errors = validationResult(req);\r\n    if (errors.isEmpty()) {\r\n      return next();\r\n    }\r\n\r\n    res.status(422).json({ errors: errors.array() });\r\n  };\r\n};\r\n"]}